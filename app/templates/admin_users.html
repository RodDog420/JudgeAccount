{% extends "base.html" %}

{% block title %}Manage Users - Judge Review{% endblock %}

{% block content %}
<h1>Manage Users</h1>

<!-- Search/Filter Form -->
<form method="GET" action="{{ url_for('auth.manage_users') }}" class="admin-search-form admin-search-form-centered">
    <h3 class="form-section-title">Search & Filter Users</h3>
    
    <div class="admin-filter-grid admin-filter-grid-wide">
        <div class="form-group">
            <label for="search_query">Search Users</label>
            <input type="text" id="search_query" name="search_query" 
                    value="{{ search_query or '' }}" 
                    placeholder="Username or email..." class="form-control">
        </div>
        
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status" class="form-control">
                <option value="" {% if not status %}selected{% endif %}>All Users</option>
                <option value="active" {% if status == 'active' %}selected{% endif %}>Active Only</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="sort_by">Sort By</label>
            <select id="sort_by" name="sort_by" class="form-control">
                <option value="username_asc" {% if sort_by == 'username_asc' %}selected{% endif %}>Username (A-Z)</option>
                <option value="username_desc" {% if sort_by == 'username_desc' %}selected{% endif %}>Username (Z-A)</option>
                <option value="joined_desc" {% if sort_by == 'joined_desc' %}selected{% endif %}>Recently Joined</option>
                <option value="joined_asc" {% if sort_by == 'joined_asc' %}selected{% endif %}>Oldest First</option>
                <option value="reviews_desc" {% if sort_by == 'reviews_desc' %}selected{% endif %}>Most Reviews</option>
                <option value="media_desc" {% if sort_by == 'media_desc' %}selected{% endif %}>Most Media Links</option>
                <option value="last_activity_desc" {% if sort_by == 'last_activity_desc' %}selected{% endif %}>Recently Active</option>
            </select>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <a href="{{ url_for('auth.manage_users') }}" class="btn btn-secondary">Clear Filters</a>
        <a href="{{ url_for('auth.view_banned_users') }}" class="btn btn-danger">View Banned Users</a>
    </div>
</form>

<!-- User Management Section (Bulk Actions + Table grouped together) -->
<div class="admin-section-group">
    
    <!-- Bulk Actions Box -->
    <form method="POST" action="{{ url_for('auth.bulk_actions') }}" id="bulk-action-form" class="admin-bulk-actions-box">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        
        <div class="bulk-action-bar">
            <label for="bulk-action-select">Bulk Action:</label>
            <select id="bulk-action-select" name="bulk_action" class="form-control">
                <option value="">Select Action</option>
                <option value="ban">Ban Selected Users</option>
                <option value="delete">Delete Selected Users</option>
            </select>
            
            <input type="text" id="bulk-reason" name="bulk_ban_reason" 
                    placeholder="Reason for action..." class="form-control" required>
            
            <button type="submit" class="btn btn-danger" 
                    onclick="return confirm('Are you sure you want to perform this bulk action on selected users?');">
                Execute
            </button>
            
            <span id="selected-count" class="bulk-count">0 selected</span>
        </div>
    </form>

    <!-- Users Table Box -->
    <div class="admin-table-box" id="admin-user-table">
        <div class="admin-table-controls">
            <p class="content-count">Showing {{ user_data|length }} user(s)</p>
            <button type="button" class="btn btn-secondary btn-small mobile-only" id="toggle-columns">
                Show All Columns
            </button>
        </div>

        {% if user_data %}
        <table class="admin-user-table-desktop">
            <thead>
                <tr>
                    <th class="table-col-narrow">
                        <input type="checkbox" id="select-all" title="Select All" form="bulk-action-form">
                    </th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Reviews</th>
                    <th>Media</th>
                    <th>Last</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for data in user_data %}
                <tr>
                    <td>
                        {% if not data.user.is_admin and data.user.id != current_user.id %}
                        <input type="checkbox" name="user_ids[]" value="{{ data.user.id }}" 
                                class="user-checkbox" form="bulk-action-form">
                        {% endif %}
                    </td>
                    <td class="user-content-username">
                        <a href="{{ url_for('auth.view_user_activity', user_id=data.user.id) }}">
                            {{ data.user.username }}
                        </a>
                    </td>
                    <td class="table-cell-muted user-content-email">{{ data.user.email }}</td>
                    <td>
                        {% if data.user.is_banned %}
                            <span class="badge badge-concern badge-small">BANNED</span>
                        {% else %}
                            <span class="badge badge-active badge-small">ACTIVE</span>
                        {% endif %}
                    </td>
                    <td class="table-cell-muted table-cell-date-wrapped">
                        {{ data.user.created_at.strftime('%b %d,') }}<br>{{ data.user.created_at.strftime('%Y') }}
                    </td>
                    <td class="table-cell-center">{{ data.review_count }}</td>
                    <td class="table-cell-center">{{ data.verified_media_count }}</td>
                    <td class="table-cell-muted table-cell-date-wrapped">
                        {% if data.user.last_active %}
                            {{ data.user.last_active.strftime('%b %d,') }}<br>{{ data.user.last_active.strftime('%Y') }}
                        {% else %}
                            Never
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('auth.view_user_activity', user_id=data.user.id) }}" 
                            class="btn btn-primary btn-small">
                            View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Mobile Card View -->
        <div class="admin-user-cards-mobile">
            {% for data in user_data %}
            <div class="admin-user-card-mobile">
                <!-- Checkbox for bulk selection -->
                {% if not data.user.is_admin and data.user.id != current_user.id %}
                <div class="admin-user-card-checkbox">
                    <input type="checkbox" name="user_ids[]" value="{{ data.user.id }}" 
                            class="user-checkbox" form="bulk-action-form" id="mobile-check-{{ data.user.id }}">
                    <label for="mobile-check-{{ data.user.id }}">Select for bulk action</label>
                </div>
                {% endif %}
                
                <!-- Card Header -->
                <div class="admin-user-card-header">
                    <h3 class="admin-user-card-name">
                        <a href="{{ url_for('auth.view_user_activity', user_id=data.user.id) }}" class="user-content-username">
                            {{ data.user.username }}
                        </a>
                    </h3>
                    <div class="admin-user-card-badges">
                        {% if data.user.is_banned %}
                            <span class="badge badge-concern badge-small">BANNED</span>
                        {% else %}
                            <span class="badge badge-active badge-small">ACTIVE</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Card Details -->
                <div class="admin-user-card-details">
                    <div class="admin-user-card-row admin-user-card-row-email">
                        <span class="admin-user-card-label">Email:</span>
                        <span class="admin-user-card-value user-content-email">{{ data.user.email }}</span>
                    </div>
                    <div class="admin-user-card-row">
                        <span class="admin-user-card-label">Joined:</span>
                        <span class="admin-user-card-value">{{ data.user.created_at.strftime('%b %d, %Y') }}</span>
                    </div>
                    <div class="admin-user-card-row">
                        <span class="admin-user-card-label">Reviews:</span>
                        <span class="admin-user-card-value">{{ data.review_count }}</span>
                    </div>
                    <div class="admin-user-card-row">
                        <span class="admin-user-card-label">Media:</span>
                        <span class="admin-user-card-value">{{ data.verified_media_count }}</span>
                    </div>
                    <div class="admin-user-card-row">
                        <span class="admin-user-card-label">Last Active:</span>
                        <span class="admin-user-card-value">
                            {% if data.user.last_active %}
                                {{ data.user.last_active.strftime('%b %d, %Y') }}
                            {% else %}
                                Never
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <!-- Card Actions -->
                <div class="admin-user-card-actions">
                    <a href="{{ url_for('auth.view_user_activity', user_id=data.user.id) }}" 
                        class="btn btn-primary btn-small">
                        View Profile
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% else %}
        <div class="no-reviews">
            <p>No users found matching your criteria.</p>
        </div>
        {% endif %}
    </div>

</div>

<script>
// Bulk action checkbox handling
const selectAllCheckbox = document.getElementById('select-all');
const userCheckboxes = document.querySelectorAll('.user-checkbox');
const selectedCount = document.getElementById('selected-count');
const bulkReasonInput = document.getElementById('bulk-reason');
const bulkActionSelect = document.getElementById('bulk-action-select');

function updateSelectedCount() {
    const checked = document.querySelectorAll('.user-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
    
    // Enable/disable bulk action controls based on selection
    const hasSelection = checked > 0;
    bulkActionSelect.disabled = !hasSelection;
    bulkReasonInput.disabled = !hasSelection;
}

// Select all functionality
if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
        userCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
}

// Individual checkbox functionality
userCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        // Update select-all checkbox
        const allChecked = Array.from(userCheckboxes).every(cb => cb.checked);
        const noneChecked = Array.from(userCheckboxes).every(cb => !cb.checked);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
        }
        
        updateSelectedCount();
    });
});

// Initialize count on page load
updateSelectedCount();

// Disable bulk action controls initially
bulkActionSelect.disabled = true;
bulkReasonInput.disabled = true;

// Toggle all columns visibility on mobile
const toggleColumnsBtn = document.getElementById('toggle-columns');
const adminTableBox = document.getElementById('admin-user-table');

if (toggleColumnsBtn && adminTableBox) {
    let showingAll = false;
    
    toggleColumnsBtn.addEventListener('click', function() {
        showingAll = !showingAll;
        
        if (showingAll) {
            adminTableBox.classList.add('show-all-columns');
            this.textContent = 'Show Priority Columns';
        } else {
            adminTableBox.classList.remove('show-all-columns');
            this.textContent = 'Show All Columns';
        }
    });
}
</script>
{% endblock %}